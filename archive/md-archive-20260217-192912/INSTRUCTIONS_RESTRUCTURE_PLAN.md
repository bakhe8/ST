# خطة إعادة هيكلة النظام لتحقيق الاستقلالية التامة للمتاجر

## 1. مقدمة

تهدف هذه الخطة إلى إعادة هيكلة النظام بحيث يصبح كل متجر افتراضي وحدة مستقلة تمامًا (بيانات، ثيمات، محتوى، إعدادات)، مع ضمان سهولة الإدارة، الأمان، وقابلية التوسع.

---

## 2. الوضع الحالي

- جميع المتاجر الافتراضية، السيناريوهات، الثيمات، والمحتوى تُخزن في قاعدة بيانات مركزية واحدة (SQLite/Prisma).
- كل متجر مرتبط بجداول مشتركة (virtualStore، scenario، dataEntity، themeVersion...) ويُحدد عبر معرف المتجر (storeId).
- الخدمات تتعامل مباشرة مع قاعدة البيانات، وتسمح بإنشاء وتعديل وحذف المتاجر، لكن العلاقات والبيانات مرتبطة بجداول مركزية.
- حذف متجر لا يضمن حذف جميع البيانات المرتبطة تلقائيًا (قد تبقى سيناريوهات أو كيانات معلقة).
- النظام يسمح بمشاركة الثيمات أو الإعدادات بين المتاجر إذا رغب المطور بذلك.
- سهولة إدارة البيانات المركزية، وتوحيد عمليات البحث والتحليل عبر جميع المتاجر.

---

## 3. الملاحظات على الوضع الحالي

- تداخل البيانات بين المتاجر يحد من المرونة ويعرض النظام لمخاطر فقدان أو تداخل البيانات.
- لا توجد آليات تحقق من صحة أو سلامة البيانات عند العمليات الحرجة (حذف، تعديل).
- لا توجد آليات تصدير أو استيراد متجر كامل بشكل مستقل.
- لا توجد اختبارات تكامل للتحقق من العزل التام بين المتاجر.

---

## 4. الأهداف الجديدة

- استقلالية تامة لكل متجر (بيانات، ثيمات، محتوى، إعدادات).
- إمكانية تصدير واستيراد متجر كامل.
- عزل العمليات والبيانات بين المتاجر.
- سهولة التخصيص والتوسع دون تداخل أو فقدان بيانات.

---

## 5. الاقتراحات التفصيلية

### 5.1 طبقة البيانات

- بناء Data Access Layer تضمن العزل التام للعمليات حسب معرف المتجر.
- تعديل بنية قاعدة البيانات بحيث يكون لكل متجر جداول أو قاعدة بيانات خاصة (Database per Store أو Scoped Tables).
- توثيق العلاقات بين الجداول (ERD) وربطها بالعقود البرمجية.

### 5.2 طبقة الخدمات

- فصل ملفات الثيمات والإعدادات والمحتوى لكل متجر في مجلدات مستقلة.
- بناء نظام إدارة سيناريوهات وإصدارات خاص بكل متجر.
- عند حذف متجر: تنفيذ cascade delete أو آليات تحقق لحذف السيناريوهات والكيانات والثيمات المرتبطة.

### 5.3 طبقة API

- بناء واجهات API موجهة لكل متجر، مع تحقق من الهوية والحدود (Store Context Isolation).
- جميع العمليات تتم ضمن نطاق قاعدة بيانات المتجر أو جداوله فقط، دون التأثير على متاجر أخرى.

### 5.4 عند إنشاء متجر جديد

- يتم إنشاء قاعدة بيانات أو مساحة بيانات خاصة بالمتجر (أو جداول معزولة).
- يُنشأ سجل المتجر مع جميع الإعدادات الأساسية.
- يُربط المتجر تلقائيًا بثيم أساس (يُحدد مسبقًا أو يُختار من قائمة)، وتُنسخ ملفات الثيم إلى مساحة المتجر.
- تُضاف بيانات أولية (منتجات، تصنيفات، إعدادات) من قالب افتراضي إلى قاعدة بيانات المتجر.
- تُنشأ جميع العلاقات (storeState، scenario، dataEntity...) ضمن نطاق المتجر فقط.

### 5.5 عند إدارة المتجر (تعديل، حذف، تصدير، استيراد)

- جميع العمليات تتم ضمن نطاق قاعدة بيانات المتجر أو جداوله فقط، دون التأثير على متاجر أخرى.
- حذف المتجر يؤدي إلى حذف جميع البيانات المرتبطة به (سيناريوهات، ثيمات، محتوى) تلقائيًا.
- يمكن تصدير المتجر بالكامل (قاعدة بيانات، ملفات الثيم، المحتوى) واستيراده في بيئة أخرى بسهولة.

### 5.6 عند تطوير النظام أو إضافة ميزات

- كل تطوير أو تحديث يُطبق على طبقة Data Access Layer، مما يضمن العزل التام للعمليات حسب معرف المتجر.
- يمكن إضافة قوالب ثيمات أو بيانات أولية جديدة ليتم استخدامها عند إنشاء المتاجر.
- واجهات API تعمل ضمن سياق المتجر فقط، وتمنع أي تداخل أو مشاركة بيانات.

### 5.7 عند اختبار النظام

- اختبارات التكامل تتحقق من أن كل متجر يعمل بشكل مستقل، وأن العمليات لا تؤثر على متاجر أخرى.
- يمكن اختبار تصدير واستيراد المتاجر، والتحقق من سلامة البيانات والعلاقات.

---

## 6. خارطة الطريق (خطوة بخطوة)

1. بناء Data Access Layer وتعديل الخدمات لتتعامل معها بدلًا من Prisma مباشرة، مع دعم العزل حسب معرف المتجر.
2. تعديل بنية قاعدة البيانات (أو إنشاء قواعد بيانات منفصلة) وربط جميع العمليات بمعرف المتجر.
3. فصل ملفات الثيمات والإعدادات والمحتوى لكل متجر في مجلدات مستقلة وربطها بالمتجر فقط.
4. بناء نظام إدارة سيناريوهات وإصدارات خاص بكل متجر، وربطها بقاعدة البيانات والمحتوى.
5. تعديل واجهات API لتعمل ضمن سياق المتجر فقط، وتمنع أي تداخل أو مشاركة بيانات.
6. بناء آليات حذف وتعديل تضمن حذف جميع البيانات المرتبطة بالمتجر دون التأثير على متاجر أخرى.
7. بناء آليات تصدير واستيراد متجر كامل (بما في ذلك السيناريوهات والثيمات والمحتوى).
8. بناء اختبارات تكامل للتحقق من العزل التام وعدم وجود تداخل بين المتاجر.
9. توثيق العلاقات بين الجداول (ERD) وربطها بالعقود البرمجية.

---

## 7. النتيجة المتوقعة

- استقلالية تامة لكل متجر: قاعدة بيانات، سيناريوهات، ثيمات، محتوى، وإعدادات خاصة به.
- منع التداخل أو فقدان البيانات بين المتاجر.
- سهولة تصدير أو استيراد أي متجر، أو إعادة بناءه في بيئة أخرى.
- مرونة أكبر في إدارة المتاجر وتوسيع النظام ليشمل متاجر متعددة دون مخاطر تداخل أو فقدان بيانات.
- بنية تشغيلية واضحة، مع إمكانية مراقبة الصحة وإدارة المهام الخلفية بسهولة.
- اختبارات تكامل قوية تضمن سلامة التفاعل بين جميع الطبقات واستقلالية المتاجر.

---

## 8. ملاحظات ختامية

- تطبيق هذه الخطة يتطلب جهدًا هندسيًا وتنسيقًا بين جميع الفرق.
- يجب توثيق كل خطوة وتحديث جميع الأدلة البرمجية والوثائق.
- القرار النهائي بين الاستقلالية التامة أو الإدارة المركزية يعتمد على متطلبات العمل والأمان والتوسع.
