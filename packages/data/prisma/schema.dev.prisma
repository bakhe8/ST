generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Theme {
  id            String         @id
  nameAr        String?
  nameEn        String?
  repository    String?
  authorEmail   String?
  supportUrl    String?
  descriptionAr String?
  descriptionEn String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  storeStates   StoreState[]
  versions      ThemeVersion[]
}

model ThemeVersion {
  id               String       @id @default(uuid())
  themeId          String
  version          String
  fsPath           String
  contractJson     String
  capabilitiesJson String?
  schemaHash       String?
  createdAt        DateTime     @default(now())
  storeStates      StoreState[]
  theme            Theme        @relation(fields: [themeId], references: [id])

  @@unique([themeId, version])
}

model VirtualStore {
  id              String     @id @default(uuid())
  title           String
  defaultLocale   String     @default("ar-SA")
  defaultCurrency String     @default("SAR")
  brandingJson    String?    @default("{}")
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  scenarios       Scenario[]
}

model Scenario {
  id               String            @id @default(uuid())
  storeId          String
  name             String
  isActive         Boolean           @default(false)
  metaJson         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  collections      Collection[]
  componentStates  ComponentState[]
  dataBindings     DataBinding[]
  dataEntities     DataEntity[]
  pageCompositions PageComposition[]
  store            VirtualStore      @relation(fields: [storeId], references: [id])
  snapshots        Snapshot[]
  storeState       StoreState?
}

model StoreState {
  scenarioId     String       @id
  themeId        String
  themeVersionId String
  activePage     String       @default("home")
  viewport       String       @default("desktop")
  settingsJson   String
  updatedAt      DateTime     @updatedAt
  themeVersion   ThemeVersion @relation(fields: [themeVersionId], references: [id])
  theme          Theme        @relation(fields: [themeId], references: [id])
  scenario       Scenario     @relation(fields: [scenarioId], references: [id])
}

model ComponentState {
  id             String   @id @default(uuid())
  scenarioId     String
  componentPath  String
  componentKey   String?
  instanceOrder  Int
  settingsJson   String
  visibilityJson String?
  updatedAt      DateTime @updatedAt
  scenario       Scenario @relation(fields: [scenarioId], references: [id])

  @@unique([scenarioId, componentPath, instanceOrder])
}

model PageComposition {
  id              String   @id @default(uuid())
  scenarioId      String
  page            String
  compositionJson String
  updatedAt       DateTime @updatedAt
  scenario        Scenario @relation(fields: [scenarioId], references: [id])

  @@unique([scenarioId, page])
}

model DataEntity {
  id          String   @id @default(uuid())
  scenarioId  String
  entityType  String
  entityKey   String?
  payloadJson String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  scenario    Scenario @relation(fields: [scenarioId], references: [id])

  @@unique([scenarioId, entityType, entityKey])
}

model Collection {
  id         String           @id @default(uuid())
  scenarioId String
  name       String
  source     String
  rulesJson  String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  scenario   Scenario         @relation(fields: [scenarioId], references: [id])
  items      CollectionItem[]
}

model CollectionItem {
  collectionId String
  entityId     String
  sortOrder    Int
  collection   Collection @relation(fields: [collectionId], references: [id])

  @@id([collectionId, entityId])
}

model DataBinding {
  id            String   @id @default(uuid())
  scenarioId    String
  componentPath String
  bindingKey    String
  sourceType    String
  sourceRef     String
  bindingJson   String?
  updatedAt     DateTime @updatedAt
  scenario      Scenario @relation(fields: [scenarioId], references: [id])
}

model Snapshot {
  id           String   @id @default(uuid())
  scenarioId   String
  label        String
  snapshotJson String
  createdAt    DateTime @default(now())
  scenario     Scenario @relation(fields: [scenarioId], references: [id])
}
