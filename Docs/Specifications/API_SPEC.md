# VTDR API Specification (As-Is)

Last updated: 2026-02-19  
Cleanup pass: 2026-02-17 (Docs scope reduction)  
Primary source: `apps/api/src/index.ts` + route files under `apps/api/src/routes/`.

## 1) Canonical Route Inventory

- Generated snapshot (authoritative list): `Docs/VTDR/API-ROUTES.snapshot.json`
- Generated by: `npm run docs:sync`
- Drift check: `npm run docs:drift`

## 2) Base URL

- API root: `/api`
- Runtime preview (non-API): `/preview/*`
- Runtime context render (non-API): `/render`

## 3) Context Contract

Context-aware endpoints resolve store context by this order:

1. `x-vtdr-store-id`
2. `context-store-id`
3. `store_id` query param
4. `:storeId` or `:id` route param
5. `/preview/:storeId/...` path

If required context is missing or invalid:

- `400 { success: false, error: ... }`

## 4) Route Groups

### 4.1 System

- `GET /api/system/info`
- `GET /api/system/status`
- `GET /api/system/preview/metrics?limit=<n>`
  - يعيد baseline ونافذة metrics حديثة لمسار preview rendering من `PreviewRenderOrchestrator`.

### 4.2 Theme Management

- `GET /api/themes`
- `POST /api/themes/discover`
- `POST /api/themes/register`
- `POST /api/themes/sync`

### 4.3 Store Management

Mounted twice on the same handlers:

- `/api/stores/*`
- `/api/v1/stores/*`

Main operations:

- list/create store
- get/update/delete store
- clone/promote/inherit
- seed/sync
- patch store settings
- clear store data

### 4.4 Simulator Resources (Context Required)

- Cart:
  - `GET /api/v1/cart`
  - `POST /api/v1/cart/items`
  - `PATCH /api/v1/cart/items/:itemId`
  - `DELETE /api/v1/cart/items/:itemId`
- Products: `/api/v1/products*`
  - Query filters/sort (as-is):
    - `status=in-stock|out-of-stock|low-stock|backorder|hidden`
    - `featured=true|false`
    - `sort=priceFromLowToTop|priceFromTopToLow|stockFromLowToTop|stockFromTopToLow|featured|latest|bestSell|topRated`
- Categories: `/api/v1/categories*`
- Static pages: `/api/v1/static-pages*`
  - Compatibility aliases:
    - `GET /api/v1/pages`
    - `GET /api/v1/pages/:id`
- Menus: `GET /api/v1/menus/:type`
  - Compatibility alias:
    - `GET /api/v1/footer` (maps to footer menu payload)
- Theme settings:
  - `GET /api/v1/theme/settings`
  - `PUT /api/v1/theme/settings`
- Theme components:
- `GET /api/v1/theme/components`
- Mock auth:
  - `POST /api/v1/auth/login`

### 4.5 Runtime Rendering

- `GET /preview/:storeId/:themeId/:version`
- `POST /render`

### 4.6 Health

- `GET /api/health`
- `GET /api/debug/test`

## 5) Response Shape (Current Reality)

- Standard helper (`ok/fail`) is used on `system/theme/store` routes and context/error handlers.
- Most successful API responses use:

```json
{ "status": 200, "success": true, "data": {} }
```

- Simulator responses include pagination/metadata and preserve matching HTTP status for create/read/update/delete.
- Cart endpoints are store-scoped simulator endpoints and return the same envelope contract.
- Operational endpoints that return a message keep the same envelope and include `data: null`, for example:

```json
{ "status": 200, "success": true, "data": null, "message": "..." }
```

- Runtime preview endpoint (`GET /preview/...`) is HTML by design and not JSON-wrapped.

## 6) Known Compatibility Notes

- UI API base is `/api`, preview URL is built by removing trailing `/api` and targeting `/preview/...`.
- Vite dev proxy forwards `/api`, `/preview`, and `/themes` to API server.

## 7) Change Policy

Any route addition/removal/change requires, in the same change:

1. `npm run docs:sync`
2. API docs update (this file if group/contract changed)
3. Passing `npm run docs:drift`
