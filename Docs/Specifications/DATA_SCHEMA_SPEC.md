# VTDR Data Schema Specification (As-Is)

Last updated: 2026-02-18  
Cleanup pass: 2026-02-17 (Docs scope reduction)  
Primary source: `packages/data/prisma/schema.prisma`

## 1) Canonical Schema Snapshot
- Generated snapshot: `Docs/VTDR/DATA-SCHEMA.snapshot.json`
- Generated by: `npm run docs:sync`
- Drift check: `npm run docs:drift`
- Current sha256: `13603a93c65e4ecc941baff68c14511dba0dab758c7f0e0f78698bb4c6de67d2`

## 2) Data Store
- Provider: SQLite
- Prisma datasource key: `db`
- URL from env: `DATABASE_URL`

## 3) Core Modeling Principle
- Runtime is Store-First.
- `Store` is the anchor entity for runtime state and content entities.
- Theme settings are persisted in `themeSettingsJson` and are intentionally separated from `brandingJson`.

## 4) Model Inventory
Current models:
1. `Theme`
2. `ThemeVersion`
3. `Store`
4. `StoreState`
5. `ComponentState`
6. `PageComposition`
7. `DataEntity`
8. `Collection`
9. `CollectionItem`
10. `DataBinding`
11. `Snapshot`

## 5) Key Constraints
- `ThemeVersion`: `@@unique([themeId, version])`
- `ComponentState`: `@@unique([storeId, componentPath, instanceOrder])`
- `PageComposition`: `@@unique([storeId, page])`
- `DataEntity`: `@@unique([storeId, entityType, entityKey])`
- `CollectionItem`: `@@id([collectionId, entityId])`

## 6) Store Runtime State Fields
`Store` contains:
- identity + locale/currency
- active theme/version
- runtime view state (`activePage`, `viewport`)
- JSON payloads:
  - `settingsJson`
  - `themeSettingsJson`
  - `brandingJson`

## 7) Mutation Surfaces (Runtime)
Main writes happen via:
- Store CRUD and settings update routes
- Simulator CRUD routes for `product/category/page` through `DataEntity`
- Theme settings update route writing to `themeSettingsJson`

## 8) Change Policy
Any Prisma schema change requires, in the same change:
1. Update schema file.
2. Run `npm run docs:sync`.
3. Update this spec when model semantics changed.
4. Pass `npm run docs:drift`.
